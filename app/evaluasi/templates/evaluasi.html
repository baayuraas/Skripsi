{% extends 'base.html' %}

{% block page_title %}
<div class="page-title">
  <div><h1><i class="icon-shield"></i> Evaluasi Model</h1></div>
</div>
{% endblock %}

{% block breadcrumbs %}
<div id="breadcrumbs">
  <ul class="breadcrumb"><li class="active"><i class="icon-home"></i> Home</li></ul>
</div>
{% endblock %}

{% block content %}
<!-- Form Upload Data -->
<form id="eval-form" enctype="multipart/form-data">
  <label for="file">Upload File CSV (Data Uji):</label>
  <input type="file" id="file" name="file" accept=".csv" required>
  <button type="submit" class="btn btn-primary">Upload & Evaluasi</button>
</form>

<!-- Form Sampling Data -->
<div id="sampling-section" style="display: none;" class="mt-4">
  <h4>Ambil Sampel Data</h4>
  <form id="sampling-form" class="form-inline">
    <div class="form-group mr-2">
      <label for="total_samples" class="mr-2">Total Sampel:</label>
      <input type="number" id="total_samples" name="total_samples" min="1" class="form-control" required>
    </div>
    <div class="form-group mr-2">
      <label for="positive_samples" class="mr-2">Positif:</label>
      <input type="number" id="positive_samples" name="positive_samples" min="0" class="form-control" required>
    </div>
    <div class="form-group mr-2">
      <label for="negative_samples" class="mr-2">Negatif:</label>
      <input type="number" id="negative_samples" name="negative_samples" min="0" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-success mr-2">Ambil Sampel</button>
    <button type="button" id="evaluate-sampled" class="btn btn-warning">Evaluasi Sampel</button>
  </form>
  <div id="data-info" class="mt-2"></div>
</div>

<div id="loading" style="display:none" class="mt-2">⏳ Memproses evaluasi...</div>
<div id="statusMessage" class="mt-2"></div>

<div id="review-table-box" style="display: none;">
    <div class="mt-3">
      <button id="clear-data" class="btn btn-danger">Hapus Semua Data</button>
      <button class="btn btn-outline-primary" onclick="window.location='/evaluasi/download/data_eval.csv'">Download Data Evaluasi</button>
      <button class="btn btn-outline-primary" onclick="window.location='/evaluasi/download/hasil_evaluasi.csv'">Download Hasil Evaluasi</button>
      <button class="btn btn-outline-success" onclick="window.location='/evaluasi/download/data_sampled.csv'">Download Data Sampel</button>
    </div>

    <div class="table-responsive mt-4">
      <table class="table table-bordered">
        <thead id="table-header"></thead>
        <tbody id="reviews-table-body"></tbody>
      </table>
    </div>

    <div id="confusion-matrix-wrapper" class="mt-4"></div>
    <div id="metrics-wrapper" class="mt-4"></div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(function () {
  function renderTable(data) {
    if (!data.length) return;
    const keys = Object.keys(data[0]);
    $("#table-header").html(`<tr><th>#</th>${keys.map(k => `<th>${k}</th>`).join("")}</tr>`);
    $("#reviews-table-body").html(
      data.map((row, i) => `
        <tr><td>${i + 1}</td>${
          keys.map(k => {
            const mismatch = k === "Status" && row["Asli"] && row[k] !== row["Asli"];
            return `<td style="${mismatch ? 'background:#f8d7da;color:#721c24' : ''}">${row[k]}</td>`;
          }).join("")
        }</tr>`
      ).join("")
    );
  }

  function renderConfusionMatrix(matrix, labels) {
    if (!matrix.length) return;
    let html = "<h5>Confusion Matrix:</h5><table class='table table-bordered'><thead><tr><th></th>";
    html += labels.map(l => `<th>${l}</th>`).join("") + "</tr></thead><tbody>";
    matrix.forEach((row, i) => {
      html += `<tr><th>${labels[i]}</th>${row.map(c => `<td>${c}</td>`).join("")}</tr>`;
    });
    html += "</tbody></table>";
    $("#confusion-matrix-wrapper").html(html);
  }

  function renderMetrics(metrics) {
    if (!metrics) return;
    const html = `
      <h5>Skor Evaluasi:</h5>
      <ul>
        <li><strong>Akurasi:</strong> ${metrics.accuracy}%</li>
        <li><strong>Presisi:</strong> ${metrics.precision}%</li>
        <li><strong>Recall:</strong> ${metrics.recall}%</li>
        <li><strong>F1-Score:</strong> ${metrics.f1_score}%</li>
      </ul>`;
    $("#metrics-wrapper").html(html);
  }

  function updateDataInfo() {
    $.get("/evaluasi/get_data_info", function(response) {
      if (response.error) {
        $("#data-info").html(`<span style="color:red;">${response.error}</span>`);
        return;
      }
      
      let infoHtml = `<strong>Data Tersedia:</strong> ${response.total_data} total`;
      Object.entries(response.label_counts).forEach(([label, count]) => {
        infoHtml += ` | ${label}: ${count}`;
      });
      $("#data-info").html(infoHtml);
      
      // Tampilkan section sampling
      $("#sampling-section").show();
      
    }).fail(function(xhr) {
      $("#data-info").html(`<span style="color:red;">Gagal memuat informasi data</span>`);
    });
  }

  // Fungsi untuk memeriksa dan memproses data yang sudah ada
  function checkAndProcessExistingData() {
    $.get("/evaluasi/check_existing_data", function(response) {
      if (response.exists) {
        $("#statusMessage").html("<span style='color:blue'>⏳ Memuat data yang sudah ada...</span>");
        updateDataInfo();
        
        // Coba muat hasil evaluasi sebelumnya
        loadSavedResults();
      } else {
        // Jika tidak ada data yang tersimpan, sembunyikan section sampling
        $("#sampling-section").hide();
      }
    }).fail(function() {
      $("#sampling-section").hide();
    });
  }

  // Fungsi untuk memuat hasil evaluasi yang tersimpan
  function loadSavedResults() {
    $.get("/evaluasi/get_saved_data", function(response) {
      if (response.data && response.data.length > 0) {
        renderTable(response.data);
        $('#review-table-box').show();
        $("#statusMessage").html("<span style='color:green'>Data evaluasi tersimpan dimuat</span>");
      }
    }).fail(function(xhr) {
      // Tidak menampilkan error jika tidak ada data tersimpan
      if (xhr.status !== 404) {
        console.error("Gagal memuat data tersimpan:", xhr.responseJSON?.error);
      }
    });
  }

  // Panggil fungsi saat halaman dimuat
  checkAndProcessExistingData();

  // Form upload data
  $("#eval-form").submit(function (e) {
    e.preventDefault();
    $("#statusMessage").empty();
    $("#loading").show();

    const formData = new FormData(this);
    $.ajax({
      url: "/evaluasi/evaluate",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: res => {
        $("#loading").hide();
        $("#statusMessage").html(`<span style="color:green;">${res.message}</span>`);
        renderTable(res.data || []);
        renderConfusionMatrix(res.confusion_matrix, res.labels);
        renderMetrics(res.metrics);
        $('#review-table-box').show();
        updateDataInfo();
      },
      error: xhr => {
        $("#loading").hide();
        const msg = xhr.responseJSON?.error || "❌ Gagal evaluasi.";
        $("#statusMessage").html(`<span style="color:red;">${msg}</span>`);
      }
    });
  });

  // Form sampling data
  $("#sampling-form").submit(function (e) {
    e.preventDefault();
    const total = parseInt($("#total_samples").val());
    const positif = parseInt($("#positive_samples").val());
    const negatif = parseInt($("#negative_samples").val());

    if (positif + negatif !== total) {
      $("#statusMessage").html(`<span style="color:red;">Jumlah positif + negatif harus sama dengan total sampel</span>`);
      return;
    }

    $("#statusMessage").empty();
    $("#loading").show();

    $.ajax({
      url: "/evaluasi/sample_data",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        total_samples: total,
        positive_samples: positif,
        negative_samples: negatif
      }),
      success: res => {
        $("#loading").hide();
        $("#statusMessage").html(`<span style="color:green;">${res.message}</span>`);
        renderTable(res.sampled_data || []);
        $('#review-table-box').show();
      },
      error: xhr => {
        $("#loading").hide();
        const msg = xhr.responseJSON?.error || "❌ Gagal mengambil sampel.";
        $("#statusMessage").html(`<span style="color:red;">${msg}</span>`);
      }
    });
  });

  // Evaluasi data sampel
  $("#evaluate-sampled").click(function () {
    $("#statusMessage").empty();
    $("#loading").show();

    $.post("/evaluasi/evaluate_sampled", function(res) {
      $("#loading").hide();
      $("#statusMessage").html(`<span style="color:green;">${res.message}</span>`);
      renderTable(res.data || []);
      renderConfusionMatrix(res.confusion_matrix, res.labels);
      renderMetrics(res.metrics);
      $('#review-table-box').show();
    }).fail(function(xhr) {
      $("#loading").hide();
      const msg = xhr.responseJSON?.error || "❌ Gagal evaluasi data sampel.";
      $("#statusMessage").html(`<span style="color:red;">${msg}</span>`);
    });
  });

  $("#clear-data").click(() => {
    $.post("/evaluasi/clear", res => {
      $("#statusMessage").text(res.message);
      $("#table-header, #reviews-table-body, #confusion-matrix-wrapper, #metrics-wrapper").empty();
      $('#review-table-box').hide();
      $('#sampling-section').hide();
      $("#data-info").empty();
    }).fail(xhr => {
      $("#statusMessage").html(`<span style="color:red;">${xhr.responseJSON?.error || "Gagal menghapus data"}</span>`);
    });
  });

  // Auto-calculate negative samples when total and positive are entered
  $("#total_samples, #positive_samples").on("input", function() {
    const total = parseInt($("#total_samples").val()) || 0;
    const positif = parseInt($("#positive_samples").val()) || 0;
    const negatif = total - positif;
    
    if (negatif >= 0) {
      $("#negative_samples").val(negatif);
    }
  });
});
</script>
{% endblock %}