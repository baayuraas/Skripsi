{% extends 'base.html' %}

{% block page_title %}
<div class="page-title">
    <div><h1><i class="fa fa-language"></i> Terjemahan Data Steam</h1></div>
</div>
{% endblock %}

{% block breadcrumbs %}
<div id="breadcrumbs">
    <ul class="breadcrumb">
        <li><i class="fa fa-home"></i> Home</li>
        <li class="active">Terjemahan</li>
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="box">
            <div class="box-header">
                <h3 class="box-title">Terjemahan Ulasan Steam</h3>
            </div>
            <div class="box-body">
                <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i>
                    <strong>Informasi:</strong> Sistem akan menerjemahkan ulasan dari bahasa asli ke Bahasa Indonesia. 
                    Data yang sudah diterjemahkan akan disimpan dalam cache untuk mempercepat proses berikutnya.
                </div>

                <form id="upload-form" enctype="multipart/form-data" class="form-horizontal">
                    <div class="form-group">
                        <label for="file" class="col-sm-3 control-label">Unggah File CSV:</label>
                        <div class="col-sm-9">
                            <input type="file" name="file" id="file" accept=".csv" required class="form-control">
                            <span class="help-block">
                                File harus berformat CSV dengan kolom: <code>SteamID, Ulasan, Status</code>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-9">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <i class="fa fa-upload"></i> Unggah dan Terjemahkan
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Loading Spinner -->
                <div id="loading-spinner" style="display: none; margin-top: 20px;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <h4 class="mt-3">‚è≥ Sedang menerjemahkan...</h4>
                        <p>Proses ini mungkin memakan waktu beberapa menit tergantung jumlah data.</p>
                        
                        <div class="progress" style="height: 25px; margin: 20px 0;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                        </div>
                        
                        <div id="progress-stats" class="text-muted">
                            <small>Memproses: <span id="processed-count">0</span> / <span id="total-count">0</span> baris</small>
                        </div>
                    </div>
                </div>

                <!-- Message Alert -->
                <div id="message" class="alert" style="display: none; margin-top: 15px;"></div>

                <!-- Results Section -->
                <div id="review-table-box" class="mt-4" style="display: none;">
                    <div class="box">
                        <div class="box-header with-border">
                            <h3 class="box-title">Hasil Terjemahan</h3>
                            <div class="box-tools pull-right">
                                <span id="data-stats" class="badge bg-blue"></span>
                            </div>
                        </div>
                        <div class="box-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <button id="clear-data" class="btn btn-danger">
                                        <i class="fa fa-trash"></i> Hapus Semua Data
                                    </button>
                                </div>
                                <div class="col-md-6 text-right">
                                    <button id="download-btn" class="btn btn-success">
                                        <i class="fa fa-download"></i> Download Hasil (CSV)
                                    </button>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-inline">
                                        <label for="rowsPerPageSelect" class="mr-2">Baris per halaman:</label>
                                        <select id="rowsPerPageSelect" class="form-control">
                                            <option value="10">10</option>
                                            <option value="25" selected>25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 text-right">
                                    <div id="data-count" class="text-muted"></div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered table-striped table-hover">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="15%">SteamID</th>
                                            <th width="35%">Ulasan (Original)</th>
                                            <th width="35%">Terjemahan (Indonesia)</th>
                                            <th width="10%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reviews-table-body"></tbody>
                                </table>
                            </div>

                            <div id="pagination" class="text-center mt-3">
                                <nav>
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" id="prev-page">
                                            <a class="page-link" href="javascript:void(0)">Sebelumnya</a>
                                        </li>
                                        <li class="page-item disabled">
                                            <span class="page-text mx-3">
                                                Halaman <span id="current-page">1</span> dari <span id="total-pages">1</span>
                                            </span>
                                        </li>
                                        <li class="page-item" id="next-page">
                                            <a class="page-link" href="javascript:void(0)">Berikutnya</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(function () {
    let translatedData = [], currentPage = 1, rowsPerPage = 25;

    // Fungsi untuk menampilkan pesan
    function showMessage(message, type) {
        const messageDiv = $('#message');
        const icon = type === 'success' ? 'fa-check' : 
                    type === 'danger' ? 'fa-exclamation-triangle' : 
                    type === 'warning' ? 'fa-warning' : 'fa-info';
        
        messageDiv.removeClass('alert-success alert-danger alert-info alert-warning')
                 .addClass('alert-' + type)
                 .html(`<i class="fa ${icon}"></i> ${message}`)
                 .show();
        
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                messageDiv.fadeOut();
            }, 8000);
        }
    }

    // Fungsi untuk update progress bar
    function updateProgress(percent, processed = 0, total = 0) {
        const progressBar = $('#progress-bar');
        progressBar.css('width', percent + '%').text(percent + '%');
        
        if (processed > 0 && total > 0) {
            $('#processed-count').text(processed);
            $('#total-count').text(total);
            const remaining = total - processed;
            if (remaining > 0) {
                $('#progress-stats').html(`<small>Memproses: ${processed} / ${total} baris (${remaining} tersisa)</small>`);
            } else {
                $('#progress-stats').html(`<small>Menyelesaikan proses...</small>`);
            }
        }
    }

    // Fungsi untuk merender tabel dengan pagination
    function renderTable(data) {
        const tableBody = $('#reviews-table-body').empty();
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const totalPages = Math.max(1, Math.ceil(data.length / rowsPerPage));
        
        $('#total-pages').text(totalPages);
        $('#data-count').text(`Menampilkan ${Math.min(rowsPerPage, data.length)} dari ${data.length} baris`);
        $('#data-stats').text(`${data.length} baris`);
        
        if (!data.length) {
            tableBody.append(`<tr><td colspan="5" class="text-center text-muted">Tidak ada data terjemahan</td></tr>`);
            $('#prev-page, #next-page').addClass('disabled');
            return;
        }
        
        // Update status tombol pagination
        $('#prev-page').toggleClass('disabled', currentPage === 1);
        $('#next-page').toggleClass('disabled', currentPage === totalPages);
        
        // Render rows
        data.slice(start, end).forEach((row, i) => {
            const rowNumber = start + i + 1;
            const statusClass = row.Status === 'Positive' ? 'label-success' : 
                              row.Status === 'Negative' ? 'label-danger' : 'label-warning';
            const statusText = row.Status || 'Unknown';
            const translationText = row.Terjemahan ? escapeHtml(row.Terjemahan) : 
                                  '<span class="text-muted"><i>Gagal diterjemahkan</i></span>';
            
            tableBody.append(`
                <tr>
                    <td class="text-center">${rowNumber}</td>
                    <td><code>${escapeHtml(row.SteamID || '')}</code></td>
                    <td style="word-wrap: break-word; max-width: 300px;">${escapeHtml(row.Ulasan || '')}</td>
                    <td style="word-wrap: break-word; max-width: 300px;">${translationText}</td>
                    <td class="text-center"><span class="label ${statusClass}">${escapeHtml(statusText)}</span></td>
                </tr>
            `);
        });
        $('#current-page').text(currentPage);
    }

    // Fungsi untuk escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Fungsi untuk memuat data dari server
    function loadSavedData() {
        $.get('/terjemahan/get_saved_data')
            .done(function(response) {
                if (response.error) {
                    console.log('Tidak ada data tersimpan:', response.error);
                } else if (response.data && response.data.length > 0) {
                    translatedData = response.data;
                    currentPage = 1;
                    renderTable(translatedData);
                    $('#review-table-box').show();
                    showMessage(`Data terjemahan berhasil dimuat (${translatedData.length} baris)`, 'info');
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Gagal memuat data tersimpan:', error);
            });
    }

    // Memuat data yang sudah ada saat halaman dimuat
    loadSavedData();

    // Event handler untuk perubahan jumlah baris per halaman
    $('#rowsPerPageSelect').change(function () {
        rowsPerPage = parseInt($(this).val());
        currentPage = 1;
        renderTable(translatedData);
    });

    // Event handler untuk form upload
    $('#upload-form').submit(function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = $('#submit-btn');
        
        // Disable submit button and show loading
        submitBtn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Memproses...');
        $('#loading-spinner').show();
        updateProgress(10, 0, 0);
        
        $.ajax({
            url: '/terjemahan/translate',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        updateProgress(percent, 0, 0);
                    }
                });
                return xhr;
            },
            success: res => {
                // Simulate progress updates during processing
                let progress = 30;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress < 90) {
                        updateProgress(progress, Math.round(progress * (res.stats?.total_rows || 100) / 100), res.stats?.total_rows || 100);
                    } else {
                        clearInterval(progressInterval);
                        updateProgress(100, res.stats?.total_rows || 100, res.stats?.total_rows || 100);
                        
                        setTimeout(() => {
                            $('#loading-spinner').hide();
                            submitBtn.prop('disabled', false).html('<i class="fa fa-upload"></i> Unggah dan Terjemahkan');
                            
                            const stats = res.stats || {};
                            const timeMsg = stats.total_time ? `Waktu: ${stats.total_time} detik` : '';
                            showMessage(`${res.message} ${timeMsg}`, 'success');
                            
                            if (res.data) {
                                translatedData = res.data;
                                currentPage = 1;
                                renderTable(translatedData);
                                $('#review-table-box').show();
                            }
                        }, 1000);
                    }
                }, 500);
            },
            error: xhr => {
                $('#loading-spinner').hide();
                submitBtn.prop('disabled', false).html('<i class="fa fa-upload"></i> Unggah dan Terjemahkan');
                const errorMsg = xhr.responseJSON?.error || '‚ùå Terjadi kesalahan saat menerjemahkan.';
                showMessage(errorMsg, 'danger');
            }
        });
    });

    // Event handler untuk tombol hapus data
    $('#clear-data').click(function () {
        if (confirm('Apakah Anda yakin ingin menghapus semua data terjemahan dan cache? Tindakan ini tidak dapat dibatalkan.')) {
            $.post('/terjemahan/cleardata')
                .done(function (res) {
                    showMessage(res.message, 'success');
                    translatedData = [];
                    currentPage = 1;
                    $('#review-table-box').hide();
                    renderTable([]);
                })
                .fail(function(xhr) {
                    showMessage('Gagal menghapus data', 'danger');
                });
        }
    });

    // Event handler untuk tombol download
    $('#download-btn').click(function() {
        if (!translatedData || translatedData.length === 0) {
            showMessage('Tidak ada data untuk diunduh', 'warning');
            return;
        }
        window.location.href = '/terjemahan/savedata';
    });

    // Event handler untuk tombol pagination
    $('#prev-page').click(() => { 
        if (currentPage > 1) {
            currentPage--; 
            renderTable(translatedData);
        }
    });
    
    $('#next-page').click(() => { 
        if (currentPage * rowsPerPage < translatedData.length) {
            currentPage++; 
            renderTable(translatedData);
        }
    });
});
</script>

<style>
.progress {
    border-radius: 10px;
}
.progress-bar {
    border-radius: 10px;
    transition: width 0.3s ease;
}
.table td {
    vertical-align: middle;
}
.label {
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
}
.label-success { background-color: #00a65a; }
.label-danger { background-color: #dd4b39; }
.label-warning { background-color: #f39c12; }
.page-item.disabled .page-link {
    background-color: #f4f4f4;
    color: #999;
}
</style>
{% endblock %}