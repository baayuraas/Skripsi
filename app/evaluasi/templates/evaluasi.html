{% extends 'base.html' %}

{% block page_title %}
<div class="page-title">
  <div><h1><i class="icon-shield"></i> Evaluasi Model</h1></div>
</div>
{% endblock %}

{% block breadcrumbs %}
<div id="breadcrumbs">
  <ul class="breadcrumb"><li class="active"><i class="icon-home"></i> Home</li></ul>
</div>
{% endblock %}

{% block content %}
<!-- Form Upload Data -->
<form id="eval-form" enctype="multipart/form-data">
  <label for="file">Upload File CSV (Data Uji):</label>
  <input type="file" id="file" name="file" accept=".csv" required>
  <button type="submit" class="btn btn-primary">Upload & Evaluasi</button>
</form>

<!-- Form Sampling Data -->
<div id="sampling-section" style="display: none;" class="mt-4">
  <h4>Ambil Sampel Data</h4>
  <form id="sampling-form" class="form-inline">
    <div class="form-group mr-2">
      <label for="total_samples" class="mr-2">Total Sampel:</label>
      <input type="number" id="total_samples" name="total_samples" min="1" class="form-control" required>
    </div>
    <div class="form-group mr-2">
      <label for="positive_samples" class="mr-2">Positif:</label>
      <input type="number" id="positive_samples" name="positive_samples" min="0" class="form-control" required>
    </div>
    <div class="form-group mr-2">
      <label for="negative_samples" class="mr-2">Negatif:</label>
      <input type="number" id="negative_samples" name="negative_samples" min="0" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-success mr-2">Ambil Sampel</button>
    <button type="button" id="evaluate-sampled" class="btn btn-warning">Evaluasi Sampel</button>
  </form>
  <div id="data-info" class="mt-2"></div>
</div>

<div id="loading" style="display:none" class="mt-2">⏳ Memproses evaluasi...</div>
<div id="statusMessage" class="mt-2"></div>

<div id="review-table-box" style="display: none;">
    <div class="mt-3">
      <button id="clear-data" class="btn btn-danger">Hapus Semua Data</button>
      <button class="btn btn-outline-primary" onclick="window.location='/evaluasi/download/data_eval.csv'">Download Data Evaluasi</button>
      <button class="btn btn-outline-primary" onclick="window.location='/evaluasi/download/hasil_evaluasi.csv'">Download Hasil Evaluasi</button>
      <button class="btn btn-outline-success" onclick="window.location='/evaluasi/download/data_sampled.csv'">Download Data Sampel</button>
    </div>

    <div id="table-info" class="mt-3"></div>

    <div class="table-responsive mt-4">
      <table class="table table-bordered">
        <thead id="table-header"></thead>
        <tbody id="reviews-table-body"></tbody>
      </table>
    </div>

    <!-- Tampilan confusion matrix dan metrik seperti program perhitungan -->
    <div id="eval-info" class="mt-4"></div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(function () {
  function renderTable(data, displayedColumns, totalColumns) {
    if (!data.length) return;
    const keys = Object.keys(data[0]);
    
    // Tambahkan informasi tentang kolom
    let tableInfo = "";
    if (displayedColumns !== undefined && totalColumns !== undefined && displayedColumns < totalColumns) {
        tableInfo = `<div class="alert alert-info">
            <i class="icon-info-sign"></i> 
            Menampilkan ${displayedColumns} dari ${totalColumns} fitur. 
            Proses perhitungan menggunakan semua ${totalColumns} fitur.
        </div>`;
    } else if (displayedColumns !== undefined && totalColumns !== undefined) {
        tableInfo = `<div class="alert alert-success">
            <i class="icon-ok"></i> 
            Menampilkan semua ${totalColumns} fitur.
        </div>`;
    }
    
    $("#table-header").html(`<tr><th>#</th>${keys.map(k => `<th>${k}</th>`).join("")}</tr>`);
    $("#reviews-table-body").html(
      data.map((row, i) => `
        <tr><td>${i + 1}</td>${
          keys.map(k => {
            const mismatch = k === "Status" && row["Asli"] && row[k] !== row["Asli"];
            return `<td style="${mismatch ? 'background:#f8d7da;color:#721c24' : ''}">${row[k]}</td>`;
          }).join("")
        }</tr>`
      ).join("")
    );
    
    // Tambahkan info di atas tabel
    $("#table-info").html(tableInfo);
  }

  // Fungsi untuk render confusion matrix dan metrik seperti program perhitungan
  function renderEvaluation(res) {
    if (res.labels && res.confusion_matrix) {
      const labels = res.labels;
      const cm = res.confusion_matrix;
      
      // Render confusion matrix
      let matrix = `<h5>Confusion Matrix:</h5><table class="table table-bordered"><thead><tr><th></th>`;
      matrix += labels.map(l => `<th><strong>${l}</strong></th>`).join("") + "</tr></thead><tbody>";
      cm.forEach((row, i) => {
        matrix += `<tr><th><strong>${labels[i]}</strong></th>${row.map(c => `<td>${c}</td>`).join("")}</tr>`;
      });
      matrix += "</tbody></table>";
      
      // Render metrik evaluasi seperti program perhitungan
      let metrics = ``;
      if (res.metrics) {
        metrics = `
          <h5 class="mt-4">Metrik Evaluasi:</h5>
          <ul class="list-unstyled">
            <li><strong>Akurasi:</strong> ${res.metrics.accuracy}%</li>
            <li><strong>Presisi:</strong> ${res.metrics.precision}%</li>
            <li><strong>Recall:</strong> ${res.metrics.recall}%</li>
            <li><strong>F1-Score:</strong> ${res.metrics.f1_score}%</li>
          </ul>`;
      }
      
      $("#eval-info").html(matrix + metrics);
    }
  }

  function updateDataInfo() {
    $.get("/evaluasi/get_data_info", function(response) {
      if (response.error) {
        $("#data-info").html(`<span style="color:red;">${response.error}</span>`);
        return;
      }
      
      let infoHtml = `<strong>Data Tersedia:</strong> ${response.total_data} total data, ${response.total_features} fitur`;
      Object.entries(response.label_counts).forEach(([label, count]) => {
        infoHtml += ` | ${label}: ${count}`;
      });
      $("#data-info").html(infoHtml);
      
      // Tampilkan section sampling
      $("#sampling-section").show();
      
    }).fail(function(xhr) {
      $("#data-info").html(`<span style="color:red;">Gagal memuat informasi data</span>`);
    });
  }

  // Fungsi untuk memeriksa dan memproses data yang sudah ada
  function checkAndProcessExistingData() {
    $.get("/evaluasi/check_existing_data", function(response) {
      if (response.exists) {
        $("#statusMessage").html("<span style='color:blue'>⏳ Memuat data yang sudah ada...</span>");
        updateDataInfo();
        
        // Coba muat hasil evaluasi sebelumnya
        loadSavedResults();
      } else {
        // Jika tidak ada data yang tersimpan, sembunyikan section sampling
        $("#sampling-section").hide();
      }
    }).fail(function() {
      $("#sampling-section").hide();
    });
  }

  // Fungsi untuk memuat hasil evaluasi yang tersimpan
  function loadSavedResults() {
    $.get("/evaluasi/get_saved_evaluation", function(response) {
      if (response.data && response.data.length > 0) {
        renderTable(response.data, response.displayed_columns, response.total_features);
        
        // Jika ada hasil evaluasi tersimpan, render juga evaluasinya
        if (response.metrics && response.confusion_matrix && response.labels) {
          renderEvaluation({
            metrics: response.metrics,
            confusion_matrix: response.confusion_matrix,
            labels: response.labels
          });
        }
        
        $('#review-table-box').show();
        $("#statusMessage").html("<span style='color:green'>Data evaluasi tersimpan dimuat</span>");
      }
    }).fail(function(xhr) {
      // Tidak menampilkan error jika tidak ada data tersimpan
      if (xhr.status !== 404) {
        console.error("Gagal memuat data tersimpan:", xhr.responseJSON?.error);
      }
    });
  }

  // Panggil fungsi saat halaman dimuat
  checkAndProcessExistingData();

  // Form upload data
  $("#eval-form").submit(function (e) {
    e.preventDefault();
    $("#statusMessage").empty();
    $("#loading").show();

    const formData = new FormData(this);
    $.ajax({
      url: "/evaluasi/evaluate",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: res => {
        $("#loading").hide();
        
        let message = res.message;
        if (res.dimensional_adjustment) {
          message += `<br><span style="color: orange;">⚠️ Warning: Dimensi fitur disesuaikan (${res.actual_features_used} → ${res.expected_features}) - ${res.adjustment_message}</span>`;
        }
        
        $("#statusMessage").html(`<span style="color:green;">${message}</span>`);
        renderTable(res.data || [], res.displayed_columns, res.total_features);
        
        // Render evaluasi seperti program perhitungan
        renderEvaluation(res);
        
        $('#review-table-box').show();
        updateDataInfo();
        
        // Simpan hasil evaluasi
        saveEvaluationResults(res);
      },
      error: xhr => {
        $("#loading").hide();
        const msg = xhr.responseJSON?.error || "❌ Gagal evaluasi.";
        $("#statusMessage").html(`<span style="color:red;">${msg}</span>`);
      }
    });
  });

  // Form sampling data
  $("#sampling-form").submit(function (e) {
    e.preventDefault();
    const total = parseInt($("#total_samples").val());
    const positif = parseInt($("#positive_samples").val());
    const negatif = parseInt($("#negative_samples").val());

    if (positif + negatif !== total) {
      $("#statusMessage").html(`<span style="color:red;">Jumlah positif + negatif harus sama dengan total sampel</span>`);
      return;
    }

    $("#statusMessage").empty();
    $("#loading").show();

    $.ajax({
      url: "/evaluasi/sample_data",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        total_samples: total,
        positive_samples: positif,
        negative_samples: negatif
      }),
      success: res => {
        $("#loading").hide();
        $("#statusMessage").html(`<span style="color:green;">${res.message}</span>`);
        renderTable(res.sampled_data || [], res.displayed_features, res.total_features);
        $('#review-table-box').show();
      },
      error: xhr => {
        $("#loading").hide();
        const msg = xhr.responseJSON?.error || "❌ Gagal mengambil sampel.";
        $("#statusMessage").html(`<span style="color:red;">${msg}</span>`);
      }
    });
  });

  // Evaluasi data sampel
  $("#evaluate-sampled").click(function () {
    $("#statusMessage").empty();
    $("#loading").show();

    $.post("/evaluasi/evaluate_sampled", function(res) {
      $("#loading").hide();
      
      let message = res.message;
      if (res.dimensional_adjustment) {
        message += `<br><span style="color: orange;">⚠️ Warning: Dimensi fitur disesuaikan (${res.actual_features_used} → ${res.expected_features}) - ${res.adjustment_message}</span>`;
      }
      
      $("#statusMessage").html(`<span style="color:green;">${message}</span>`);
      renderTable(res.data || [], res.displayed_columns, res.total_features);
      
      // Render evaluasi seperti program perhitungan
      renderEvaluation(res);
      
      $('#review-table-box').show();
      
      // Simpan hasil evaluasi
      saveEvaluationResults(res);
    }).fail(function(xhr) {
      $("#loading").hide();
      const msg = xhr.responseJSON?.error || "❌ Gagal evaluasi data sampel.";
      $("#statusMessage").html(`<span style="color:red;">${msg}</span>`);
    });
  });

  // Fungsi untuk menyimpan hasil evaluasi
  function saveEvaluationResults(evalData) {
    const dataToSave = {
      data: evalData.data || [],
      metrics: evalData.metrics || {},
      confusion_matrix: evalData.confusion_matrix || [],
      labels: evalData.labels || [],
      displayed_columns: evalData.displayed_columns || 0,
      total_features: evalData.total_features || 0,
      saved_at: new Date().toISOString()
    };
    
    $.ajax({
      url: "/evaluasi/save_evaluation_results",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(dataToSave),
      success: function(response) {
        console.log("Hasil evaluasi berhasil disimpan");
      },
      error: function(xhr) {
        console.error("Gagal menyimpan hasil evaluasi:", xhr.responseJSON?.error);
      }
    });
  }

  $("#clear-data").click(() => {
    $.post("/evaluasi/clear", res => {
      $("#statusMessage").text(res.message);
      $("#table-header, #reviews-table-body, #eval-info, #table-info").empty();
      $('#review-table-box').hide();
      $('#sampling-section').hide();
      $("#data-info").empty();
    }).fail(xhr => {
      $("#statusMessage").html(`<span style="color:red;">${xhr.responseJSON?.error || "Gagal menghapus data"}</span>`);
    });
  });

  // Auto-calculate negative samples when total and positive are entered
  $("#total_samples, #positive_samples").on("input", function() {
    const total = parseInt($("#total_samples").val()) || 0;
    const positif = parseInt($("#positive_samples").val()) || 0;
    const negatif = total - positif;
    
    if (negatif >= 0) {
      $("#negative_samples").val(negatif);
    }
  });
});
</script>
{% endblock %}  