{% extends 'base.html' %}

{% block page_title %}
<div class="page-title">
  <div><h1><i class="icon-shield"></i> TF-IDF</h1></div>
</div>
{% endblock %}

{% block breadcrumbs %}
<div id="breadcrumbs">
  <ul class="breadcrumb"><li class="active"><i class="icon-home"></i> Home</li></ul>
</div>
{% endblock %}

{% block content %}
<h3>TF-IDF</h3>

<div id="upload-form-container">
  <form id="upload-form" enctype="multipart/form-data">
    <label for="file">Unggah File CSV:</label>
    <input type="file" name="file" id="file" accept=".csv" required>
    <button type="submit" class="btn btn-primary">Unggah dan Proses</button>
  </form>
</div>

<div id="loading" style="display: none; margin-top: 10px;">⏳ Memproses data...</div>

<!-- Summary Information Box -->
<div id="summary-info" style="display: none; margin-top: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 5px;">
    <h4>📊 Summary Informasi</h4>
    <div id="summary-content"></div>
</div>

<div id="review-table-box" style="display: none;">
    <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
      <!-- Action Buttons -->
      <div style="display: flex; gap: 8px;">
        <button id="clear-data" class="btn btn-danger">Hapus Data</button>
        <button id="save-csv" class="btn btn-success">Simpan ke CSV (Display)</button>
      </div>
      
      <!-- CSV Download Buttons (Limited) -->
      <div style="display: flex; gap: 8px;">
        <button id="download-train-csv" class="btn btn-secondary">⬇️ Train CSV (Limited)</button>
        <button id="download-test-csv" class="btn btn-secondary">⬇️ Test CSV (Limited)</button>
      </div>

      <!-- CSV Download Buttons (Unlimited) -->
      <div style="display: flex; gap: 8px;">
        <button id="download-unlimited-train-csv" class="btn btn-warning">⬇️ Train CSV (Unlimited)</button>
        <button id="download-unlimited-test-csv" class="btn btn-warning">⬇️ Test CSV (Unlimited)</button>
        <button id="download-unlimited-csv" class="btn btn-warning">⬇️ Full CSV (Unlimited)</button>
      </div>
      
      <!-- Model Download Buttons -->
      <div style="display: flex; gap: 8px;">
        <button id="download-train-model" class="btn btn-info">⬇️ Train Model</button>
        <button id="download-test-model" class="btn btn-info">⬇️ Test Model</button>
        <button id="download-unlimited-model" class="btn btn-info">⬇️ Unlimited Model</button>
      </div>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-bordered">
        <thead id="table-header"></thead>
        <tbody id="reviews-table-body"></tbody>
      </table>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(function () {
    let processedData = [];
    let currentSummary = {};

    function renderTable() {
        if (!processedData.length) {
            $("#table-header, #reviews-table-body").empty();
            return;
        }
        let terms = Object.keys(processedData[0]).filter(k => k !== "Status");
        terms.push("Status");

        const thead = `<tr><th>#</th>${terms.map(t => `<th>${t}</th>`).join("")}</tr>`;
        $("#table-header").html(thead);

        $("#reviews-table-body").html(
            processedData.map((row, i) => {
                const maxVal = Math.max(...terms.map(t => parseFloat(row[t]) || 0));
                return `<tr><td>${i + 1}</td>` +
                    terms.map(t => {
                        const val = parseFloat(row[t]) || 0;
                        const display = t === "Status" ? row[t] : val.toFixed(4);
                        const style = val === maxVal && t !== "Status" ? 'background:#fffa9c;font-weight:bold' : '';
                        return `<td style="${style}">${display}</td>`;
                    }).join("") + `</tr>`;
            }).join("")
        );
    }

    function displaySummary(summary) {
        if (!summary) {
            $("#summary-info").hide();
            return;
        }
        
        currentSummary = summary;
        
        let summaryHTML = `
            <p><strong>Total Dokumen:</strong> ${summary.total_documents}</p>
            <p><strong>Total Term yang Ditampilkan:</strong> ${summary.total_terms}</p>
        `;
        
        if (summary.total_terms_unlimited) {
            summaryHTML += `<p><strong>Total Term Keseluruhan (Perhitungan):</strong> ${summary.total_terms_unlimited}</p>`;
            
            const percentage = ((summary.total_terms / summary.total_terms_unlimited) * 100).toFixed(1);
            summaryHTML += `<p><strong>Term yang Ditampilkan:</strong> ${percentage}% dari total term</p>`;
            
            summaryHTML += `<p><em>💡 Semua perhitungan menggunakan ${summary.total_terms_unlimited} term</em></p>`;
            summaryHTML += `<p><em>📁 Tersedia CSV Unlimited dengan semua ${summary.total_terms_unlimited} term untuk analisis lengkap</em></p>`;
        }
        
        $("#summary-content").html(summaryHTML);
        $("#summary-info").show();
    }

    // Fungsi untuk memuat data existing
    function loadExistingData() {
        $.ajax({
            url: "/tfidf/process",
            type: "GET",
            success: function(res) {
                if (res.data) {
                    processedData = res.data;
                    renderTable();
                    displaySummary(res.summary);
                    $('#review-table-box').show();
                    $('#upload-form-container').hide();
                }
            },
            error: function(xhr) {
                if (xhr.status !== 404) {
                    alert(xhr.responseJSON?.error || "Gagal memuat data existing");
                }
            }
        });
    }

    // Memuat data existing saat halaman dimuat
    loadExistingData();

    $("#upload-form").submit(function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        $("#loading").show();
        $.ajax({
            url: "/tfidf/process",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: res => {
                processedData = res.data;
                renderTable();
                displaySummary(res.summary);
                $('#review-table-box').show();
                $('#upload-form-container').hide();
            },
            error: xhr => {
                alert(xhr.responseJSON?.error || "❌ Gagal memproses.");
            },
            complete: () => $("#loading").hide()
        });
    });

    $("#clear-data").click(() => {
        if (confirm("Apakah Anda yakin ingin menghapus semua data TF-IDF?")) {
            $.post("/tfidf/clear", res => {
                alert(res.message);
                processedData = [];
                currentSummary = {};
                renderTable();
                $('#review-table-box').hide();
                $("#summary-info").hide();
                $('#upload-form-container').show();
            }).fail(() => alert("Gagal menghapus data."));
        }
    });

    // Download handlers - SEMUA TOMBOL
    $("#save-csv").click(() => triggerDownload("full_csv"));
    $("#download-train-csv").click(() => triggerDownload("train_csv"));
    $("#download-test-csv").click(() => triggerDownload("test_csv"));
    $("#download-unlimited-train-csv").click(() => triggerDownload("unlimited_train_csv"));
    $("#download-unlimited-test-csv").click(() => triggerDownload("unlimited_test_csv"));
    $("#download-unlimited-csv").click(() => triggerDownload("unlimited_csv"));
    $("#download-train-model").click(() => triggerDownload("train_model"));
    $("#download-test-model").click(() => triggerDownload("test_model"));
    $("#download-unlimited-model").click(() => triggerDownload("unlimited_model"));

    function triggerDownload(type) {
        window.location.href = `/tfidf/download/${type}`;
    }
});
</script>
{% endblock %}