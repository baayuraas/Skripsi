{% extends 'base.html' %}

{% block page_title %}
<div class="page-title">
  <div><h1><i class="icon-shield"></i> TF-IDF</h1></div>
</div>
{% endblock %}

{% block breadcrumbs %}
<div id="breadcrumbs">
  <ul class="breadcrumb"><li class="active"><i class="icon-home"></i> Home</li></ul>
</div>
{% endblock %}

{% block content %}
<h3>TF-IDF</h3>

<form id="upload-form" enctype="multipart/form-data">
  <label for="file">Unggah File CSV:</label>
  <input type="file" name="file" id="file" accept=".csv" required>
  <button type="submit" class="btn btn-primary">Unggah dan Proses</button>
</form>

<div id="loading" style="display: none; margin-top: 10px;">⏳ Memproses data...</div>

<div id="review-table-box" style="display: none;">
    <div style="margin-top: 1rem;">
      <button id="clear-data" class="btn btn-danger">Hapus Data</button>
      <button id="save-csv" class="btn btn-success">Simpan ke CSV</button>
      <button id="download-train-csv" class="btn btn-secondary">⬇️ Train CSV</button>
      <button id="download-test-csv" class="btn btn-secondary">⬇️ Test CSV</button>
      <button id="download-train-model" class="btn btn-secondary">⬇️ Train Model</button>
      <button id="download-test-model" class="btn btn-secondary">⬇️ Test Model</button>
    </div>

    <div class="table-responsive mt-3">
      <table class="table table-bordered">
        <thead id="table-header"></thead>
        <tbody id="reviews-table-body"></tbody>
      </table>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
$(function () {
    let processedData = [];

    function renderTable() {
        if (!processedData.length) {
            $("#table-header, #reviews-table-body").empty();
            return;
        }
        let terms = Object.keys(processedData[0]).filter(k => k !== "Status");
        terms.push("Status");

        const thead = `<tr><th>#</th>${terms.map(t => `<th>${t}</th>`).join("")}</tr>`;
        $("#table-header").html(thead);

        $("#reviews-table-body").html(
            processedData.map((row, i) => {
                const maxVal = Math.max(...terms.map(t => parseFloat(row[t]) || 0));
                return `<tr><td>${i + 1}</td>` +
                    terms.map(t => {
                        const val = parseFloat(row[t]) || 0;
                        const display = t === "Status" ? row[t] : val.toFixed(4);
                        const style = val === maxVal && t !== "Status" ? 'background:#fffa9c;font-weight:bold' : '';
                        return `<td style="${style}">${display}</td>`;
                    }).join("") + `</tr>`;
            }).join("")
        );
    }

    // Fungsi untuk memuat data existing
    function loadExistingData() {
        $.ajax({
            url: "/tfidf/load_existing",
            type: "GET",
            success: function(res) {
                if (res.data) {
                    processedData = res.data;
                    renderTable();
                    $('#review-table-box').show();
                }
            },
            error: function(xhr) {
                // Silent error - tidak perlu tampilkan alert jika tidak ada data
                if (xhr.status !== 404) {
                    alert(xhr.responseJSON?.error || "Gagal memuat data existing");
                }
            }
        });
    }

    // Memuat data existing saat halaman dimuat
    loadExistingData();

    $("#upload-form").submit(function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        $("#loading").show();
        $.ajax({
            url: "/tfidf/process",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: res => {
                processedData = res.data;
                renderTable();
                $('#review-table-box').show();
            },
            error: xhr => {
                alert(xhr.responseJSON?.error || "❌ Gagal memproses.");
            },
            complete: () => $("#loading").hide()
        });
    });

    $("#clear-data").click(() => {
        if (confirm("Apakah Anda yakin ingin menghapus semua data TF-IDF?")) {
            $.post("/tfidf/clear", res => {
                alert(res.message);
                processedData = [];
                renderTable();
                $('#review-table-box').hide();
            }).fail(() => alert("Gagal menghapus data."));
        }
    });

    $("#save-csv").click(() => triggerDownload("full_csv"));
    $("#download-train-csv").click(() => triggerDownload("train_csv"));
    $("#download-test-csv").click(() => triggerDownload("test_csv"));
    $("#download-train-model").click(() => triggerDownload("train_model"));
    $("#download-test-model").click(() => triggerDownload("test_model"));

    function triggerDownload(type) {
        window.location.href = `/tfidf/download/${type}`;
    }
});
</script>
{% endblock %}